# 懸念点コメント埋め込み & 推敲結果反映 仕様書

## 概要

ドラフト作成後の懸念点（情報不足、不確実、文字数超過など）をWord/Excelファイルに直接埋め込み、ユーザーがレビューしやすい形式で提供する機能。また、推敲ループで改善されたドラフト内容をWord/Excel入力時の参照情報として活用する。

## 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/agents/drafter.py` | `fill_fields_individually`に推敲済みドラフトを渡す |
| `src/logic/format_field_mapper.py` | `refined_draft`引数を追加、レポート簡略化 |
| `src/tools/document_filler.py` | Excel/Wordコメント埋め込み機能 |

---

## 機能詳細

### 1. 推敲結果のWord/Excel反映

推敲ループ（Critic Agent評価→改善）で改善されたドラフト内容が、Word/Excel入力時のプロンプトに参照情報として含まれるようになりました。

**メリット:**
- 推敲後の表現スタイルを踏襲した一貫性のある入力
- ドラフトと矛盾しない内容の生成

**実装:**
```python
# drafter.py
field_values = self.format_mapper.fill_fields_individually(
    fields=fields,
    profile=profile,
    grant_name=grant_name,
    grant_info=grant_info,
    refined_draft=draft_content  # 推敲後のドラフト
)
```

---

### 2. Excel懸念点コメント

懸念点がある項目には、Excelのセルコメント機能を使用して詳細を埋め込みます。

**コメント形式:**
```
【⚠️ 情報不足】
項目: 団体設立年月日
理由: プロファイルに設立日の情報が見つかりません。

※ 内容をご確認のうえ、必要に応じて修正してください。
(自動生成: Shadow Director AI)
```

**懸念点タイプ:**
| タイプ | アイコン | 説明 |
|--------|---------|------|
| `missing_info` | ⚠️ | 情報不足 |
| `uncertain` | ❓ | 要確認 |
| `length_exceeded` | 📏 | 文字数超過 |
| `truncated` | ✂️ | 回答省略 |

---

### 3. Wordネイティブコメント

WordのOOXML（Office Open XML）を直接操作して、正式なコメントを挿入します。

**実装方式:**
1. `commentRangeStart` / `commentRangeEnd` 要素でコメント範囲を指定
2. `commentReference` でコメントへの参照を追加
3. python-docxでSave後、ZIP操作で`comments.xml`を注入
4. `[Content_Types].xml`と`document.xml.rels`を更新

**メリット:**
- ✅ Wordの「コメント」パネルに一覧表示
- ✅ 返信・解決等の機能が使える
- ✅ 印刷時の表示/非表示を制御可能

**ドキュメント末尾の形式:**
```
────────────────────────────────────────
📋 Shadow Director AI - 懸念点一覧
以下の項目については、内容をご確認のうえ必要に応じて修正してください。

[※1] 【⚠️ 情報不足】団体設立年月日
    → プロファイルに設立日の情報が見つかりません。

[※2] 【📏 文字数超過】事業概要
    → 500字制限を23字超過（4.6%オーバー）

※ この懸念点一覧は提出前に削除してください。
```

---

### 4. テキストレポートの簡略化

Discordに表示されるテキストレポートは統計サマリーのみになり、詳細はWord/Excelのコメントを参照する形式に変更。

**変更前（詳細形式）:**
```markdown
## 📊 ドラフト品質レポート

**品質スコア**: 🟢 **85点** (優良)
**完成度**: 90% (45/50項目入力済み)

### ⚠️ 懸念点

#### 📏 文字数制限を超過した項目
- **事業概要**: 500字制限を23字超過（4.6%オーバー）

#### 📋 情報不足で埋められなかった項目
- **団体設立年月日**: プロファイルに設立日の情報が見つかりません。
...
```

**変更後（統計サマリー形式）:**
```markdown
## 📋 ドラフト品質サマリー

- **品質スコア**: 🟢 **85点** (優良)
- ✅ **正常入力**: 45項目
- ⚠️ **要確認**: 5項目（Word/Excelのコメントを参照）
  - 情報不足: 2項目 / 文字数超過: 2項目 / 省略あり: 1項目
- 🔧 **自動修正**: 3回の文字数超過を修正

> 💡 詳細は添付のWord/Excelファイル内のコメントをご確認ください。
```

---

## テスト確認事項

- [ ] Excelファイルの懸念点があるセルにコメントが追加されている
- [ ] Wordファイルの懸念点がある項目に `[※N]` マーカーが付いている
- [ ] Wordファイル末尾に懸念点一覧セクションがある
- [ ] Discordに表示されるレポートが統計サマリー形式になっている
- [ ] 推敲後のドラフト内容がWord/Excel入力に反映されている
