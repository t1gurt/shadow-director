# VLMフィールド抽出のチャンク分割対応 仕様書

## 概要

申請書ファイルから入力箇所を抽出する際、LLM出力トークン制限により49個程度で止まる問題を解決。
ドキュメントをチャンク分割して複数回LLM呼び出し、結果をマージする方式を採用。

## 変更内容

### 1. `_analyze_word_with_vlm` メソッド

| 項目 | 変更前 | 変更後 |
|------|--------|--------|
| 処理方式 | ドキュメント全体を1回で処理 | 4000文字ごとにチャンク分割 |
| 最大フィールド数 | 約49個（LLM出力制限） | 制限なし |

**チャンク分割ロジック**:
1. 段落を収集し、4000文字ごとにチャンク化
2. テーブルを個別にチャンク化（大きなテーブルはさらに分割）
3. 各チャンクに対してVLM解析を実行
4. 結果をマージし、重複フィールドを除去

### 2. `_enhance_fields_with_vlm` メソッド

| 項目 | 変更前 | 変更後 |
|------|--------|--------|
| 処理方式 | 全フィールドを1回で処理 | 50フィールドごとにチャンク分割 |
| 最大フィールド数 | 約50個（LLM出力制限） | 制限なし |

### 3. `_analyze_word_table` メソッド（複数テーブルパターン対応）

**対応パターン**:

#### パターン1: ラベル→入力ペア（`_detect_label_input_pattern`）
```
| ラベル1 | 入力欄1 | ラベル2 | 入力欄2 |
```
- 1行に複数の ラベル→入力ペアがある場合に対応
- 下線（`____`）、空白（`　　`）、空括弧（`（　）`）をプレースホルダーとして認識

#### パターン2: ヘッダー行＋データ行（`_detect_header_row_pattern`）
```
| 項目 | 金額 | 説明 | コメント |  ← ヘッダー行（全セルにテキスト）
|      |      |      |          |  ← データ行（入力欄）
|      |      |      |          |  ← データ行（入力欄）
```
- 1行目がヘッダー行（全セルに短いテキスト）として判定
- 2行目以降の空セルを入力欄として検出
- フィールド名に「（行N）」を付与して複数行を区別

**自動選択ロジック**:
- 両パターンで検出を試み、多く検出できた方を採用

### 4. 新規メソッド `_analyze_chunk_with_vlm`

単一チャンクをVLMで解析するヘルパーメソッドを追加。

### 5. `_analyze_word_paragraphs` メソッド（入れ子質問対応）

**対応パターン**:

#### 入れ子質問パターン
```
4. 申請プロジェクトの概要を教えてください。
　　①プロジェクト概要（600字以内）  ← サブ項目として認識
　　②実施スケジュール（400字以内）  ← サブ項目として認識
```

- 親質問（1., 2., 3.など）を検出したらコンテキストを記憶
- サブ項目（①②③, (1)(2)(3), ア.イ.ウ.など）を検出
- フィールド名を「親質問 - サブ項目」の形式で生成
  - 例: `4. 申請プロジェクトの概要 - ①プロジェクト概要`

### 6. 入力長さタイプ判定（`input_length_type`）

VLM解析時に各フィールドが短文/長文かを判定し、適切なドラフト入力を行う。

**判定タイプ**:
- `short`: 1行以内の短い入力（名前、日付、金額、電話番号など）
- `long`: 100字以上の長文入力（概要、説明、理由、計画など）
- `unknown`: 判定不能

**判定基準（VLM）**:
- 短文: テーブルセルで列幅が狭い、数値・日付・コード類、「〇〇名」「〇〇番号」
- 長文: 「概要」「説明」「理由」「目的」「計画」を含む、広いスペース

**フォールバック判定（キーワードベース）**:
- 長文キーワード: 概要, 説明, 理由, 目的, 計画, 内容, 詳細, 事業, 活動, 実績 等
- 短文キーワード: 名, 日, 年, 月, 番号, 電話, 金額, 円, 人数, ID 等

**ドキュメントフィラーでの使用**:
- 短文フィールドに長いテキストが来た場合、50字で切り詰めて`...`を付加

## 設定値

| 設定 | 値 | 説明 |
|------|-----|------|
| `CHUNK_SIZE` (テキスト) | 4000文字 | Wordドキュメントのチャンク分割サイズ |
| `CHUNK_SIZE` (フィールド) | 50個 | フィールド強化時のチャンク分割サイズ |

## ログ出力

処理状況は以下のログで確認可能:
- `[FORMAT_MAPPER] Split document into X chunks for VLM analysis`
- `[FORMAT_MAPPER] Chunk X/Y: found Z fields`
- `[FORMAT_MAPPER] VLM detected total X unique fields (from Y raw)`
- `[FORMAT_MAPPER] Table X: found Y fields (multi-field per row supported)`
