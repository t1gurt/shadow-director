# Playwright サイト探索機能 仕様書

## 概要

本機能は、Playwrightを使用したDOM解析ベースのサイト探索機能です。従来のHTTPベースの検証に加え、ヘッドレスブラウザによる深掘り探索を行うことで、助成金ページの正確な検出とフォーマットファイルの発見精度を向上させます。

## 機能概要

### 1. SiteExplorer（基盤クラス）

**ファイル**: `src/tools/site_explorer.py`

Playwrightベースのブラウザ自動化基盤クラスです。

| メソッド | 機能 |
|---------|------|
| `access_page(url)` | ヘッドレスブラウザでページにアクセス |
| `get_page_info(page)` | ページタイトル、URL、メタ情報を取得 |
| `extract_links(page)` | ページ内の全リンクを抽出 |
| `extract_file_links(page)` | ファイルリンクのみを抽出（PDF/DOC/XLS等） |
| `find_text_content(page, selector)` | 指定要素のテキストを取得 |
| `check_page_accessible(url)` | ページのアクセス可否を確認 |
| `take_screenshot(page, path)` | スクリーンショットを保存 |

**対応ファイル形式**: `.pdf`, `.doc`, `.docx`, `.xls`, `.xlsx`, `.zip`

---

### 2. GrantPageScraper（助成金ページスクレイパー）

**ファイル**: `src/logic/grant_page_scraper.py`

助成金ページ専用のスクレイピングロジックです。

| メソッド | 機能 |
|---------|------|
| `find_grant_info(url, grant_name)` | 助成金ページの情報を収集（メインエントリポイント） |
| `deep_search_format_files(url, max_depth)` | リンクを辿ってフォーマットファイルを深掘り検索 |
| `verify_grant_page(url, grant_name)` | ページが正しい助成金ページか検証 |

**検出キーワード**:
- 助成金ページ: `募集`, `公募`, `応募`, `申請`, `助成`, `補助金`, `支援`, `要項`
- フォーマットファイル: `申請書`, `応募書`, `様式`, `フォーマット`, `テンプレート`
- 締切日: `締切`, `期限`, `期日`, `終了`, `必着`

---

## 統合箇所

### GrantFinder（助成金検索）

**ファイル**: `src/logic/grant_finder.py`

URL検証後にPlaywright検証を自動実行します。

```
1. LLMがGoogle Searchで助成金URLを取得
2. HTTP検証（既存処理）
3. Playwright検証（新規追加）
   - ページの詳細検証
   - フォーマットファイルの自動検出
   - 締切日の抽出
```

### DrafterAgent（ドラフト作成）

**ファイル**: `src/agents/drafter.py`

HTTPベースの検索で見つからない場合、Playwright深掘り検索をフォールバックとして実行します。

```
1. LLMがフォーマット情報を検索
2. HTTPベースでファイルURLを抽出・ダウンロード
3. 見つからない場合 → Playwright深掘り検索（最大2階層）
```

---

## 依存関係

### Pythonパッケージ

```toml
# pyproject.toml
"playwright>=1.40.0"
```

### システム依存（Docker）

Chromiumブラウザの実行に必要なライブラリ:

```dockerfile
libnss3, libnspr4, libatk1.0-0, libatk-bridge2.0-0, libcups2,
libdrm2, libxkbcommon0, libxcomposite1, libxdamage1, libxfixes3,
libxrandr2, libgbm1, libasound2, libpango-1.0-0, libcairo2
```

---

## 処理フロー

```
┌─────────────────────────────────────────────────────────┐
│                    GrantFinder / DrafterAgent           │
│                     (既存ロジック)                        │
└─────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────┐
│                  GrantPageScraper                       │
│          助成金ページ専用のスクレイピングロジック           │
│  - 募集要項検出 / フォーマット検出 / 期間抽出              │
└─────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────┐
│                    SiteExplorer                         │
│               Playwright基盤クラス                       │
│  - ページアクセス / DOM解析 / リンク抽出                  │
└─────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────┐
│                      Playwright                         │
│               ヘッドレスブラウザ (Chromium)               │
└─────────────────────────────────────────────────────────┘
```

---

## 設定

### 環境変数

特別な環境変数は不要です。Playwrightはプロジェクト依存関係として自動インストールされます。

### タイムアウト

- デフォルトタイムアウト: 30秒
- 深掘り検索タイムアウト: 120秒

---

## 制限事項

1. **メモリ使用量**: ヘッドレスブラウザはメモリを消費するため、Cloud Runのメモリは1Gi以上を推奨
2. **実行時間**: 深掘り検索は時間がかかる場合があります（最大2分）
3. **JavaScript依存ページ**: 基本的なJS実行は可能ですが、複雑なSPAは対応が限定的

---

## バージョン履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.2.0 | 2026-01-02 | Playwright サイト探索機能を追加 |
