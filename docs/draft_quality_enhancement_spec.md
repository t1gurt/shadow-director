# ドラフト記入品質向上機能 仕様書

## 概要

本機能は、ドラフトファイル（Word/Excel）の自動記入品質を向上させるため、以下の3つの機能を強化したものです。

---

## 1. 文字数オーバー自動リトライ機能

### 機能説明
文字数制限のあるフィールドで生成内容が制限を超えた場合、自動的に短縮を試みます。

### 動作仕様
- **最大リトライ回数**: 2回
- **短縮目標**: 制限値の90%
- **リトライ失敗時**: `length_exceeded`として懸念点レポートに記録

### 実装場所
[`FormatFieldMapper.fill_fields_individually`](file:///c:/Users/keisu/workspace/shadow-director/src/logic/format_field_mapper.py#L1710-L1778)

### 出力例
```
[FORMAT_MAPPER] Field table1_3_2 exceeded max length (250 > 200, over by 50). Retry 1/2
[FORMAT_MAPPER] Retry 1: shortened to 185 chars (limit: 200)
```

---

## 2. 品質レポート機能（強化版）

### 機能説明
ドラフト全体の品質を数値で評価し、懸念点を分類して報告します。

### 出力項目

| 項目 | 説明 |
|------|------|
| 品質スコア | 0-100点（問題なし項目の割合） |
| 完成度 | 入力済み項目の割合（%） |
| 自動修正回数 | リトライで修正された回数 |

### 懸念点の分類

| 懸念タイプ | 説明 |
|------------|------|
| `length_exceeded` | 文字数制限を超過（リトライ後も） |
| `truncated` | 省略記号（...）で終わっている |
| `missing_info` | プロファイルに情報がない |
| `uncertain` | 回答に自信がない |

### 実装場所
[`FormatFieldMapper.generate_concern_report`](file:///c:/Users/keisu/workspace/shadow-director/src/logic/format_field_mapper.py#L1827-L1936)

### 出力例
```markdown
## 📊 ドラフト品質レポート

**品質スコア**: 🟢 **85点** (優良)
**完成度**: 95% (19/20項目入力済み)
**自動修正**: 3回の文字数制限超過を自動修正しました

### ⚠️ 懸念点

#### 📏 文字数制限を超過した項目
- **事業概要**: 500字制限を23字超過（4.6%オーバー）
```

---

## 3. 事務局長レビュー機能（強化版）

### 機能説明
NPO事務局長の観点から申請書ドラフトを評価し、採択可能性を含む詳細なレビューを生成します。

### 評価観点（5つ）

1. **採択可能性評価**: 高/中/低で評価
2. **申請書の説得力**: 強み・社会的意義・具体性
3. **改善すべき箇所**: 2-3箇所の具体的指摘
4. **審査員の視点**: 質問されそうなポイント
5. **提出前チェック**: 確認事項リスト

### 実装場所
[`DrafterAgent._generate_director_review`](file:///c:/Users/keisu/workspace/shadow-director/src/agents/drafter.py#L1149-L1249)

### 出力例
```markdown
## 📝 事務局長レビュー

**採択可能性**: 中 - 基本的な要件は満たしているが差別化要因が弱い

本申請書は団体の活動実績が明確に記載されており、...

**👍 良い点**
- 地域との連携体制が具体的
- 数値目標が明確

**⚡ 要改善**
- 「事業概要」に独自性を追記推奨
- 予算の積算根拠を補強

**✅ 提出前チェック**
- 代表者の押印確認
- 添付書類の最新版確認
```
